<script>
    // Check if user is already logged in when page loads
    document.addEventListener('DOMContentLoaded', function() {
        if (sessionStorage.getItem('nei_authenticated') === 'true') {
            // Redirect to tools.html if already logged in
            window.location.href = 'tools.html';
        }
    });

    async function handleCredentialResponse(response) {
        const spinner = document.getElementById('spinner');
        const errorEl = document.getElementById('error');
        
        spinner.style.display = 'block';
        errorEl.classList.add('hidden');
        
        try {
            if (!response.credential) {
                throw new Error('No credential received from Google');
            }
            
            // Decode the JWT token to get user info
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            
            // Prepare user data for notification
            const userData = {
                email: payload.email || '',
                name: payload.name || '',
                picture: payload.picture || '',
                timestamp: new Date().toISOString()
            };
            
            // Send notification to your endpoint
            await sendSignInNotification(userData);
            
            // Store authentication status with a unique key
            sessionStorage.setItem('nei_authenticated', 'true');
            sessionStorage.setItem('nei_user_email', userData.email);
            sessionStorage.setItem('nei_user_name', userData.name);
            
            // Redirect to tools.html after successful login
            window.location.href = 'tools.html';
        } catch (error) {
            console.error('Login error:', error);
            errorEl.textContent = 'Login failed. Please try again.';
            errorEl.classList.remove('hidden');
        } finally {
            spinner.style.display = 'none';
        }
    }
    
    async function sendSignInNotification(userData) {
        try {
            const response = await fetch('https://signin-notify-render-production.up.railway.app/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            });
            
            if (!response.ok) {
                console.error('Failed to send notification:', await response.text());
                // Don't throw error here - we don't want to block login if notification fails
            }
        } catch (error) {
            console.error('Error sending notification:', error);
            // Silently fail - don't interrupt user login flow
        }
    }
</script>
